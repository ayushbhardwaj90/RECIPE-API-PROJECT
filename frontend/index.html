<!DOCTYPE html>
<html lang="en" class="bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recipe Finder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        #details-drawer { transition: transform 0.3s ease-in-out; }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-gray-900">Recipe Finder</h1>
            <p class="text-lg text-gray-600 mt-2">Discover delicious recipes.</p>
        </header>

        <div class="bg-white p-6 rounded-xl shadow-sm mb-8">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
                <input type="text" id="title-filter" placeholder="Search by title..." class="col-span-1 lg:col-span-2 form-input w-full px-4 py-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                <input type="text" id="cuisine-filter" placeholder="Filter by cuisine..." class="form-input w-full px-4 py-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                <input type="text" id="rating-filter" placeholder="Rating (e.g., >=4.5)" class="form-input w-full px-4 py-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                <input type="text" id="time-filter" placeholder="Max total time (mins)" class="form-input w-full px-4 py-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
            </div>
            <div class="mt-4 flex gap-2">
                <button id="search-btn" class="px-5 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700">Apply Filters</button>
                <button id="reset-btn" class="px-5 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300">Reset</button>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 class="text-xl font-semibold">Recipes</h2>
                <div class="flex items-center gap-2">
                    <span class="text-sm text-gray-600">Per page:</span>
                    <select id="limit-select" class="form-select rounded-lg border-gray-300 shadow-sm">
                        <option value="15">15</option>
                        <option value="20">20</option>
                        <option value="30">30</option>
                        <option value="50">50</option>
                    </select>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Title</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cuisine</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Rating</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total Time</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Serves</th>
                        </tr>
                    </thead>
                    <tbody id="recipes-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>

             <div id="fallback-message" class="hidden text-center py-16 px-6">
                <h3 class="mt-2 text-lg font-medium text-gray-900">No Recipes Found</h3>
                <p class="mt-1 text-sm text-gray-500">Try adjusting your filters.</p>
            </div>

            <nav id="pagination-controls" class="bg-white px-4 py-3 flex items-center justify-between border-t"></nav>
        </div>
    </div>

    <div id="drawer-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden"></div>
    <div id="details-drawer" class="fixed top-0 right-0 h-full w-full max-w-2xl bg-white shadow-2xl z-40 transform translate-x-full overflow-y-auto"></div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let currentPage = 1;
            let currentLimit = 15;
            let allRecipesData = [];
            const API_URL = 'http://127.0.0.1:5000/api';

            const tableBody = document.getElementById('recipes-table-body');
            const searchBtn = document.getElementById('search-btn');
            const resetBtn = document.getElementById('reset-btn');
            const limitSelect = document.getElementById('limit-select');
            const paginationControls = document.getElementById('pagination-controls');
            const fallbackMessage = document.getElementById('fallback-message');
            const drawer = document.getElementById('details-drawer');
            const drawerOverlay = document.getElementById('drawer-overlay');
            
            const createStarRating = (rating) => {
                if (rating === null || isNaN(rating)) return '<span class="text-gray-400">N/A</span>';
                let stars = '';
                const fullStars = Math.floor(rating);
                const halfStar = rating % 1 >= 0.5;
                for (let i = 0; i < fullStars; i++) stars += '<i class="fas fa-star text-yellow-400"></i>';
                if (halfStar) stars += '<i class="fas fa-star-half-alt text-yellow-400"></i>';
                for (let i = 0; i < 5 - fullStars - (halfStar ? 1: 0); i++) stars += '<i class="far fa-star text-yellow-400"></i>';
                return `<div class="flex items-center gap-1">${stars} <span class="text-xs font-medium">${rating.toFixed(1)}</span></div>`;
            };

            const truncateString = (str, num) => str?.length > num ? str.slice(0, num) + '...' : str;

            const fetchRecipes = async () => {
                const title = document.getElementById('title-filter').value.trim();
                const cuisine = document.getElementById('cuisine-filter').value.trim();
                const rating = document.getElementById('rating-filter').value.trim();
                const total_time = document.getElementById('time-filter').value.trim();
                
                const hasFilters = title || cuisine || rating || total_time;
                let url = hasFilters ? `${API_URL}/recipes/search` : `${API_URL}/recipes`;
                
                const params = new URLSearchParams();
                if (hasFilters) {
                    if (title) params.append('title', title);
                    if (cuisine) params.append('cuisine', cuisine);
                    if (rating) params.append('rating', rating);
                    if (total_time) params.append('total_time', `<=${total_time}`);
                } else {
                    params.append('page', currentPage);
                    params.append('limit', currentLimit);
                }
                
                try {
                    const response = await fetch(`${url}?${params.toString()}`);
                    const result = await response.json();
                    
                    allRecipesData = result.data;
                    renderTable(result.data);
                    
                    if (!hasFilters) renderPagination(result.total, result.page, result.limit);
                    else paginationControls.innerHTML = '';

                } catch (error) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-red-500">Failed to load data. Is the backend server running?</td></tr>';
                }
            };

            const renderTable = (recipes) => {
                tableBody.innerHTML = '';
                fallbackMessage.classList.toggle('hidden', recipes.length > 0);

                recipes.forEach(recipe => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50 cursor-pointer';
                    row.dataset.recipeId = recipe.id;
                    row.innerHTML = `
                        <td class="px-6 py-4"><div class="text-sm font-medium text-gray-900">${truncateString(recipe.title, 40)}</div></td>
                        <td class="px-6 py-4 text-sm text-gray-500">${recipe.cuisine || 'N/A'}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${createStarRating(recipe.rating)}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${recipe.total_time ? `${recipe.total_time} mins` : 'N/A'}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${recipe.serves || 'N/A'}</td>`;
                    row.addEventListener('click', () => showDetails(recipe.id));
                    tableBody.appendChild(row);
                });
            };

            const renderPagination = (totalItems, page, limit) => {
                const totalPages = Math.ceil(totalItems / limit);
                paginationControls.innerHTML = totalPages <= 1 ? '' : `
                    <p class="text-sm text-gray-700">Page <span class="font-medium">${page}</span> of <span class="font-medium">${totalPages}</span></p>
                    <div class="flex gap-2">
                        <button data-page="${page - 1}" ${page <= 1 ? 'disabled' : ''} class="px-4 py-2 text-sm font-medium rounded-md border disabled:opacity-50">Previous</button>
                        <button data-page="${page + 1}" ${page >= totalPages ? 'disabled' : ''} class="px-4 py-2 text-sm font-medium rounded-md border disabled:opacity-50">Next</button>
                    </div>`;
            };

            const showDetails = (recipeId) => {
                const recipe = allRecipesData.find(r => r.id === recipeId);
                if (!recipe) return;

                const nutritionHTML = recipe.nutrients && Object.keys(recipe.nutrients).length > 0
                    ? `<table class="min-w-full divide-y divide-gray-200 mt-2">${Object.entries(recipe.nutrients).map(([key, value]) => `<tr><td class="px-4 py-2 text-sm font-medium text-gray-600 capitalize">${key.replace(/([A-Z])/g, ' $1').trim()}</td><td class="px-4 py-2 text-sm">${value ?? 'N/A'}</td></tr>`).join('')}</tbody></table>`
                    : '<p class="text-sm text-gray-500">No nutrition data available.</p>';

                drawer.innerHTML = `
                    <div class="p-6 sm:p-8">
                        <div class="flex justify-between items-start">
                            <h2 class="text-3xl font-bold text-gray-900 mb-2">${recipe.title}</h2>
                            <button id="close-drawer-btn" class="text-3xl font-light leading-none p-1">&times;</button>
                        </div>
                        <p class="text-sm text-indigo-600 font-semibold mb-4">${recipe.cuisine}</p>
                        <div class="grid grid-cols-3 gap-4 border-y py-4 mb-6 text-center">
                            <div><p class="text-xs text-gray-500 uppercase">Rating</p><p class="text-lg font-semibold">${recipe.rating || 'N/A'}</p></div>
                            <div><p class="text-xs text-gray-500 uppercase">Prep Time</p><p class="text-lg font-semibold">${recipe.prep_time ? `${recipe.prep_time} min` : 'N/A'}</p></div>
                            <div><p class="text-xs text-gray-500 uppercase">Cook Time</p><p class="text-lg font-semibold">${recipe.cook_time ? `${recipe.cook_time} min` : 'N/A'}</p></div>
                        </div>
                        <div class="space-y-6">
                            <div><h3 class="font-semibold text-lg">Description</h3><p class="mt-2 text-gray-600">${recipe.description || ''}</p></div>
                            <div><h3 class="font-semibold text-lg">Nutrition</h3><div class="mt-2 bg-gray-50 rounded-lg p-4">${nutritionHTML}</div></div>
                        </div>
                    </div>`;
                
                drawerOverlay.classList.remove('hidden');
                drawer.classList.remove('translate-x-full');
                document.getElementById('close-drawer-btn').addEventListener('click', closeDetails);
            };

            const closeDetails = () => {
                drawerOverlay.classList.add('hidden');
                drawer.classList.add('translate-x-full');
            };

            searchBtn.addEventListener('click', () => { currentPage = 1; fetchRecipes(); });
            resetBtn.addEventListener('click', () => {
                document.getElementById('title-filter').value = '';
                document.getElementById('cuisine-filter').value = '';
                document.getElementById('rating-filter').value = '';
                document.getElementById('time-filter').value = '';
                currentPage = 1;
                fetchRecipes();
            });
            limitSelect.addEventListener('change', (e) => { currentLimit = parseInt(e.target.value, 10); currentPage = 1; fetchRecipes(); });
            paginationControls.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (target?.dataset.page) { currentPage = parseInt(target.dataset.page, 10); fetchRecipes(); }
            });
            drawerOverlay.addEventListener('click', closeDetails);

            fetchRecipes();
        });
    </script>
</body>
</html>